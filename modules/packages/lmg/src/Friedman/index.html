<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>产程图</title>
    <style>
        .canvasbody {
            position: relative;
            border: 1px solid #f1f1f1;
			margin-left:10px;
            top: 0;
            left: 0;
        }

        .z1, .z2, .z3 {
            position: absolute;
        }

        .z2 {
            z-index: 2;
            top: 1px;
            left: 0;
        }

        .z3 {
            z-index: 3;
            top: 1px;
            left: 0;
        }
        .tlts {
            position: relative;
        }
    </style>
</head>
<body>
    <div id="pecharts" class="canvasbody">
        <canvas id='canvas' width='1200' height='480' position='absolute' class='z2'>
            <p>Your browserdoes not support the canvas element.</p>
        </canvas>
        <canvas id='canvas2' width='1200' height='480' position='absolute' class='z3'>
            <p>Your browserdoes not support the canvas element.</p>
        </canvas>
    </div>
	<div style="margin-top:500px;margin-left:60px">
	是否显示事件<input id="showtype" value="1"></input><button onclick="setting()">设置<button>
	<table border='1'>
	<tr>
		<td>序号</td>
		<td>检查时间</td>
		<td>产程时间</td>
		<td>宫口开张(cm)</td>
		<td>胎头下降</td>
		<td>血压</td>
		<td>宫缩</td>
		<td>羊水性状</td>
		<td>事件</td>
		<td>记录人</td>
	</tr>
	<tr>
		<td>1</td>
		<td>2019-09-01 12:56:00</td>
		<td>15.3</td>
		<td>3.5</td>
		<td>+5</td>
		<td>120/80</td>
		<td>30/20</td>
		<td>清</td>
		<td>阴检</td>
		<td>***</td>
	</tr>
	<tr>
		<td>自动生成</td>
		<td>时间选择，默认当前时间</td>
		<td>自动计算值，根据上一个时间-产程开始时间，计算值</td>
		<td>支持小数输入</td>
		<td>枚举 +5 +4 ~ -5</td>
		<td>血压输入</td>
		<td>宫缩输入</td>
		<td>枚举 清 1度 2度 3度</td>
		<td>枚举：阴检，人工破膜，吸氧，滴催，宫颈封闭，肛查，剖宫产</td>
		<td>系统登录用户</td>
	</tr>
	</table>
	<p>注：该表格类似obis中复诊记录，支持添加、编辑等操作</p>
	<div>
</body>
<script src="static/js/jquery-3.2.1.min.js"></script>

<script type="text/javascript">
    var maxindex = 750;
    var context = null;
    var lastx = 0;
    var lasty = 0;
    var baseleft = 50;
	var basetop = 50;
    var type = 0; //  0，伴行型 1,交叉型
	var isshowevent = 1; //是否显示事件
    var max = 210;
	var start = '2019-09-01 05:30';
	var demodata = [{'checktime':'2019-09-01 07:01','cd':'3.5','df':'-2','event':'阴检'},{'checktime':'2019-09-01 09:01','cd':'5','df':'0.5','event':'阴检'}];
    var lastcurrx = 0;
	var currentx = 10;
    function formatDate(date, format) {
        if (!date) return;
        if (!format) format = "yyyy-MM-dd";
        switch (typeof date) {
            case "string":
                date = new Date(date.replace(/-/, "/"));
                break;
            case "number":
                date = new Date(date);
                break;
        }
        if (!date instanceof Date) return;
        var dict = {
            "yyyy": date.getFullYear(),
            "M": date.getMonth() + 1,
            "d": date.getDate(),
            "H": date.getHours(),
            "m": date.getMinutes(),
            "s": date.getSeconds(),
            "MM": ("" + (date.getMonth() + 101)).substr(1),
            "dd": ("" + (date.getDate() + 100)).substr(1),
            "HH": ("" + (date.getHours() + 100)).substr(1),
            "mm": ("" + (date.getMinutes() + 100)).substr(1),
            "ss": ("" + (date.getSeconds() + 100)).substr(1)
        };
        return format.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g, function () {
            return dict[arguments[0]];
        });
    }


    var starttime = formatDate(new Date(), "HH:mm");
    function getEventPosition(ev) {
        var x, y;
        if (ev.layerX || ev.layerX == 0) {
            x = ev.layerX;
            y = ev.layerY;
        } else if (ev.offsetX || ev.offsetX == 0) {
            x = ev.offsetX;
            y = ev.offsetY;
        }
        //return {x: x, y: y};
        return x + '-' + y;
    }

    canvas = document.getElementById('canvas');
    canvas.addEventListener('click', function (e) {
        p = getEventPosition(e);
        alert(p);
    }, false);

    function showcur(x, fhr, toco) {
        context.font = 'bold 10px consolas';
        context.textAlign = 'left';
        context.textBaseline = 'top';
        context.font = 'bold 16px arial';
        context.fillStyle = 'blue';
        var title = document.getElementById('curtitle');
        title.innerHTML = 'FHR1:' + fhr + "  " + 'TOCO:' + toco;
    }

    function showbase() {

    }

    function selectfrom(lowValue, highValue) {
        var choice = highValue - lowValue + 1;
        return Math.floor(Math.random() * choice + lowValue);
    }

    function setrules(x,align) {
        var canvas = document.getElementById('canvas');
        if (canvas == null)
            return false;
        context = canvas.getContext("2d");

        context.font = 'bold 15px consolas';
        context.textAlign = align;
        context.textBaseline = 'top';
        context.fillStyle = 'rgba(0,51,102,1)'; // 轴数
        for (var i = 0; i < 11; i++) {
			context.fillText((10 - i), x, 45 + i * 40);
        }
		context.fillText('宫', 20, 100);
		context.fillText('颈', 20, 150);
		context.fillText('扩', 20, 200);
		context.fillText('张', 20, 250);
		context.fillText('(cm)', 32, 300);
        context.stroke();
		drawarc(15,350);
		drawcross(930,340);
    }

	function drawarc(x,y){
	  context.beginPath();
	  context.arc(x,y,8,0,2*Math.PI);
	  context.fillStyle="red";
	  context.strokeStyle = "red";
	  context.fill();
	  context.stroke();
	}

	function drawcross(x,y){
	  context.beginPath();
	  context.fillStyle="#394a6d";
	  context.strokeStyle = "#394a6d";
	  context.lineWidth = 0;
	  context.moveTo(x,y);
      context.lineTo(x+5,y);	  
      context.lineTo(x+20,y+15);
      context.lineTo(x+15,y+15);
      context.lineTo(x,y);
	  context.moveTo(x+15,y);
      context.lineTo(x+20,y);	  
      context.lineTo(x+5,y+15);
      context.lineTo(x,y+15);
      context.lineTo(x+15,y);
	  context.fill();
	}

    function showevent(x,y, data) {
		if(isshowevent && data!=''){
			context.textAlign = 'left';
			context.textBaseline = 'top';
			context.font = 'bold 14px arial';
			context.fillStyle = 'black';
			for(i=0;i<data.length;i++){
				context.fillText(data.charAt(i), x , basetop+y+15*i);
			}
		}
    }

	function setrrules(x,align) {
        var canvas = document.getElementById('canvas');
        if (canvas == null)
            return false;
        context = canvas.getContext("2d");

        context.font = 'bold 15px consolas';
        context.textAlign = align;
        context.textBaseline = 'top';
        context.fillStyle = 'rgba(0,51,102,1)'; // 轴数
        for (var i = 0; i < 11; i++) {
			var scale = 0;
			if(type == 0){
				scale = 5 - i;
			}else{
				scale = i - 5;
			}
			if(scale>0){
				scale = '+'+scale;
			}
			context.fillText(scale, x, 45 + i * 40);
        }
		context.fillText('胎', 930, 120);
		context.fillText('头', 930, 170);
		context.fillText('下', 930, 220);
		context.fillText('降', 930, 270);
        context.stroke();
    }

	function sethrules() {
        var canvas = document.getElementById('canvas');
        if (canvas == null)
            return false;
        context = canvas.getContext("2d");

        context.font = 'bold 15px consolas';
        context.textAlign = 'center';
        context.textBaseline = 'top';
        context.fillStyle = 'rgba(0,51,102,1)'; // 轴数
        for (var i = 1; i < 25; i++) {
			context.fillText(i, baseleft+i*35, 5+450);
        }
        context.stroke();
    }

    function setvertical(maxline) {
        var canvas = document.getElementById('canvas');
        if (canvas == null)
            return false;
        context = canvas.getContext("2d");	
		context.beginPath();
		context.strokeStyle = "rgb(150,150,150)"; // 横轴线
		context.lineWidth = 1;
        for (var i = 0; i < 10 + 1; i++) {
            context.moveTo(baseleft, basetop+40 * i);
            context.lineTo(baseleft+840, basetop+40 * i);
        }
        context.stroke();
    }

    function sethorizontal(length) {
        var canvas = document.getElementById('canvas');
        if (canvas == null)
            return false;		
		context.beginPath();
		context.lineWidth = 1.1;
        context.strokeStyle = "rgb(150,150,150)"; // 竖轴线
        for (var i = 0; i < 25; i++) {
            context.moveTo(35 * i + baseleft, basetop);
            context.lineTo(35 * i + baseleft, basetop+400);
        }
		context.stroke();
    }
	
	function converttime(start,current){
		interval = eval("new Date("+ current.replace(/\D+/g,",")+")").getTime() - eval("new Date("+ start.replace(/\D+/g,",")+")").getTime();
		interval = interval/1000;
		return (interval/(60*60)).toFixed(1);
	}

    function drawgrid(id) {
        var canvas = document.getElementById(id);
        if (canvas == null)
            return false;
        context = canvas.getContext("2d");
		var canvas2 = document.getElementById("canvas2");
		sethorizontal(900);
		setvertical(900);		
		setrules(40,'right');		
		setrrules(900,'left');
		sethrules();
    }

    function printline() {
		var canvas = document.getElementById('canvas2');
        if (canvas == null)
            return false;
        context = canvas.getContext("2d");
		
        context.clearRect(0, 0, canvas.width,canvas.height);
		var lastx,lasty1,lasty2 = 0;
        for(var i=0;i<demodata.length;i++){
			var curx = baseleft+converttime(start,demodata[i].checktime)*35;
			var cury1 = basetop+(10-Number(demodata[i].cd))*40;
			var cury2 = 0;
			if(type==0){
				cury2 = (5-Number(demodata[i].df))*40;
			}else{
				cury2 = (5+Number(demodata[i].df))*40;
			}
			drawarc(curx,cury1);
			drawcross(curx-10,cury2);
			if(lastx !=0){
				var canvas = document.getElementById('canvas');
				if (canvas == null)
					return false;
				context.beginPath();
				context.lineWidth = 2.5;
				context.strokeStyle = "red"; 
				context.moveTo(lastx ,lasty1);
				context.lineTo(curx, cury1);
				context.stroke();
				context.beginPath();
				context.lineWidth = 2.5;
				context.strokeStyle = "#394a6d"; 
				context.moveTo(lastx ,lasty2+5);
				context.lineTo(curx, cury2+5);
				context.stroke();
			}
			lastx = curx;
			lasty1 = cury1;
			lasty2 = cury2;
			showevent(curx,lasty1,demodata[i].event);
		}
    }
    drawgrid('canvas');
	printline();
	function setting(){
		var showtype = document.getElementById("showtype").value;
		isshowevent = Number(showtype);
		printline();
	}
</script>
</html>
