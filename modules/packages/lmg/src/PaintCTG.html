<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>胎监中央站</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css"
      media="all"
    />
    <style>
      .canvasbody {
        position: relative;
        border: 1px solid #f1f1f1;
        overflow-x: scroll;
        width: 1500px;
        height: 452px;
        top: 0;
        left: 0;
      }

      .z1,
      .z2,
      .z3 {
        position: absolute;
      }

      .z2 {
        z-index: 2;
        top: 1px;
        left: 0;
      }

      .z3 {
        z-index: 3;
        top: 1px;
        left: 0;
      }
      .tlts {
        position: relative;
      }
      .tlts .btn {
        position: absolute;
        left: 190px;
        top: 0;
      }
    </style>
  </head>
  <body>
    <div class="tlts">
      <h4 id="curtitle">CTG</h4>
      <button type="button" id="btnpause" class="btn btn-primary btn-xs">
        <i class="glyphicon glyphicon-pause"></i>
      </button>
      <button type="button" id="btnplay" class="btn btn-primary btn-xs">
        <i class="glyphicon glyphicon-play"></i>
      </button>
    </div>
    <div id="pecharts" class="canvasbody">
      <canvas
        id="canvas"
        width="1500"
        height="430"
        position="absolute"
        class="z2"
      >
        <p>Your browserdoes not support the canvas element.</p>
      </canvas>
      <canvas
        id="canvas2"
        width="1500"
        height="430"
        position="absolute"
        class="z3"
      >
        <p>Your browserdoes not support the canvas element.</p>
      </canvas>
    </div>

    <audio src="out.wav" id="audio" width="800"></audio>
  </body>
  <script src="./static/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
      document.querySelector("#btnplay").click(function() {
        btnaudioplay();
      });
      document.querySelector("#btnpause").click(function() {
        btnaudiopause();
      });
    });

    function btnaudioplay() {
      document.querySelector("#btnplay").hide();
      document.querySelector("#btnpause").show();
      audio = document.getElementById("audio");
      audio.play();
      timeout = false;
      timerscoll(1000);
    }
    function btnaudiopause() {
      document.querySelector("#btnpause").hide();
      document.querySelector("#btnplay").show();
      timeout = true;
      audio = document.getElementById("audio");
      audio.pause();
    }
    var timeout = false; //启动及关闭按钮
    function timerscoll(dely) {
      if (timeout) {
        return;
      }
      movescoll();
      setTimeout(timerscoll, 800); //time是指本身,延时递归调用自己,100为间隔调用时间,单位毫秒
    }
    $.ajaxSettings.async = false;
    var orifhr;
    var oritoco;
    var orifm;
    var orifmp;
    var fhr = [];
    var toco = [];
    var fm = [];
    var fmp = [];
    var rulercolor = "rgb(67,205,128)";
    $.getJSON("data.json", function(data) {
      orifhr = data.fhr;
      oritoco = data.toco;
      orifm = data.fm;
      orifmp = data.fmp;
      initfhrdata(orifhr, fhr);
      initfhrdata(oritoco, toco);
      initfhrdata(orifmp, fmp);
      initfhrdata(orifm, fm);
    });

    //胎心数据处理
    function initfhrdata(oridata, arrdata) {
      if (!oridata) {
        return;
      }
      var push_account = oridata.length / 2;
      for (var i = 0; i < push_account; i++) {
        var data_to_push = oridata.substring(0, 2);
        var data_to_push = parseInt(data_to_push, 16);
        arrdata.push(data_to_push);
        /*
						if(data_to_push==0){
				arrdata.push('-');
			}else{
				//kisi 2016-04-18
				if(arrdata[i-1] == '-'){
					arrdata.push(data_to_push);
				}
				else{
					if(arrdata[i-1]>data_to_push+30 || arrdata[i-1]<data_to_push-30){
						arrdata.push('-');
					}
					else{
					}
				}
			}*/
        oridata = oridata.substring(2, oridata.length);
      }
    }
  </script>
  <script type="text/javascript">
    var maxindex = 750;
    var context = null;
    var lastx = 0;
    var lasty = 0;
    //var maxline = 800;
    var baseleft = 0;
    var min = 50;
    var max = 210;
    var lastcurrx = 0;
    var seconds;
    var currentx = 10;
    function formatDate(date, format) {
      if (!date) return;
      if (!format) format = "yyyy-MM-dd";
      switch (typeof date) {
        case "string":
          date = new Date(date.replace(/-/, "/"));
          break;
        case "number":
          date = new Date(date);
          break;
      }
      if (!date instanceof Date) return;
      var dict = {
        yyyy: date.getFullYear(),
        M: date.getMonth() + 1,
        d: date.getDate(),
        H: date.getHours(),
        m: date.getMinutes(),
        s: date.getSeconds(),
        MM: ("" + (date.getMonth() + 101)).substr(1),
        dd: ("" + (date.getDate() + 100)).substr(1),
        HH: ("" + (date.getHours() + 100)).substr(1),
        mm: ("" + (date.getMinutes() + 100)).substr(1),
        ss: ("" + (date.getSeconds() + 100)).substr(1)
      };
      return format.replace(/(yyyy|MM?|dd?|HH?|ss?|mm?)/g, function() {
        return dict[arguments[0]];
      });
    }

    var starttime = formatDate(new Date(), "HH:mm");
    function getEventPosition(ev) {
      var x, y;
      if (ev.layerX || ev.layerX == 0) {
        x = ev.layerX;
        y = ev.layerY;
      } else if (ev.offsetX || ev.offsetX == 0) {
        x = ev.offsetX;
        y = ev.offsetY;
      }
      //return {x: x, y: y};
      return x + "-" + y;
    }

    canvas = document.getElementById("canvas");
    canvas.addEventListener(
      "click",
      function(e) {
        p = getEventPosition(e);
        alert(p);
      },
      false
    );

    function showcur(x, fhr, toco) {
      context.font = "bold 10px consolas";
      context.textAlign = "left";
      context.textBaseline = "top";
      context.font = "bold 16px arial";
      context.fillStyle = "blue";
      var title = document.getElementById("curtitle");
      title.innerHTML = "FHR1:" + fhr + "  " + "TOCO:" + toco;
      //context.fillText('FHR1:'+fhr, x-50,5);
      //context.fillText('TOCO:'+toco, x-50,20);
    }

    function showbase() {}

    function showacc(x, y) {
      context.font = "bold 10px consolas";
      context.textAlign = "left";
      context.textBaseline = "top";
      context.font = "bold 20px arial";
      context.fillStyle = "black";
      context.fillText("+", x + 1, y + 5);
    }

    function testclear() {
      context.font = "bold 10px consolas";
      context.textAlign = "left";
      context.textBaseline = "top";
      context.font = "bold 18px arial";
      context.fillStyle = "#999999";
      context.fillText("+", 25, 25);
      context.clearRect(25, 25, 18, 18);
    }

    function selectfrom(lowValue, highValue) {
      var choice = highValue - lowValue + 1;
      return Math.floor(Math.random() * choice + lowValue);
    }

    function setrules(x) {
      var canvas = document.getElementById("canvas");
      if (canvas == null) return false;
      context = canvas.getContext("2d");

      context.font = "bold 10px consolas";
      context.textAlign = "left";
      context.textBaseline = "top";
      context.fillStyle = "rgba(0,51,102,0.5)"; // 轴数
      for (var i = 1; i < (max - min) / 10 + 1; i++) {
        if (i % 2 == 1) {
          context.fillText(max - i * 10, x, i * 15 - 8);
        }
      }
      for (var i = 0; i < 11; i++) {
        if (i % 2 == 0) {
          context.fillText((10 - i) * 10, x, max + 60 + i * 15 - 8);
        }
      }
      context.stroke();
    }

    function setvertical(maxline) {
      var canvas = document.getElementById("canvas");
      if (canvas == null) return false;
      context = canvas.getContext("2d");
      for (var i = 1; i < (max - min) / 10 + 1; i++) {
        context.beginPath();
        context.strokeStyle = "rgba(0,102,204,0.4)"; // 横轴线
        context.lineWidth = 0.2;
        if (i % 2 == 1) {
          context.lineWidth = 1;
        }
        context.moveTo(baseleft, 15 * i);
        context.lineTo(maxline, 15 * i);
        context.stroke();
      }
      for (var i = 0; i < 11; i++) {
        context.beginPath();
        context.strokeStyle = "rgba(0,102,204,0.4)"; // 横轴线
        context.lineWidth = 0.2;
        if (i % 2 == 0) {
          context.lineWidth = 1;
        }
        context.moveTo(baseleft, max + 60 + i * 15);
        context.lineTo(maxline, max + 60 + i * 15);
        context.stroke();
      }
    }

    function sethorizontal(length) {
      var canvas = document.getElementById("canvas");
      if (canvas == null) return false;
      context.strokeStyle = "#eee"; // 竖轴线
      for (var i = 1; i < length / 25; i++) {
        context.beginPath();
        context.strokeStyle = "rgba(0,3,3,0.4)";
        context.lineWidth = 0.5;
        if (i % 3 == 0) {
          context.strokeStyle = "rgba(0,3,3,0.4)";
          context.lineWidth = 1.2;
        }
        if (i % 9 == 1) {
          setrules(25 * i);
        }
        if (i % 6 == 1) {
          context.font = "bold 10px consolas";
          context.textAlign = "left";
          context.textBaseline = "top";
          context.font = "bold 10px arial";
          context.fillStyle = "black";
          var flag = ((i - 1) / 6) % 2;
          if (flag == 0) {
            context.fillText(starttime, i * 25 - 20, max + 30);
          } else {
            context.fillText((i - 1) / 3 + "分", i * 25 - 20, max + 30);
          }
        }
        context.moveTo(25 * i + baseleft, max + 60);
        context.lineTo(25 * i + baseleft, max + 60 + 150);
        context.stroke();
      }
      for (var i = 1; i < length / 25; i++) {
        context.beginPath();
        context.lineWidth = 0.6;
        if (i % 3 == 0) {
          context.lineWidth = 1.1;
        }
        if (i % 9 == 1) {
          setrules(25 * i);
        }
        context.moveTo(25 * i + baseleft, 0);
        context.lineTo(25 * i + baseleft, ((max - min) * 15) / 10);
        context.stroke();
      }
      for (var i = 1; i < length / 75; i++) {
        context.beginPath();
        context.lineWidth = 0.6;
        if (i % 3 == 0) {
          context.lineWidth = 1.1;
        }
        if (i % 9 == 1) {
          setrules(25 * i);
        }
        if (i % 6 == 1) {
          context.font = "bold 10px consolas";
          context.textAlign = "left";
          context.textBaseline = "top";
          context.font = "bold 10px arial";
          context.fillStyle = "black";
          var flag = ((i - 1) / 6) % 2;
          if (flag == 0) {
            context.fillText(starttime, i * 25 - 20, max + 30);
          } else {
            context.fillText((i - 1) / 3 + "分", i * 25 - 20, max + 30);
          }
        }
        context.moveTo(25 * i + baseleft, 0);
        context.lineTo(25 * i + baseleft, ((max - min) * 15) / 10);
        context.stroke();
      }
    }
    function setnewhorzontal() {
      var canvas = document.getElementById("canvas");
      if (canvas == null) return false;
      context.strokeStyle = "rgb(150,150,150)";
      //实验证明第一次lineTo的时候和moveTo功能一样
      //之后的lineTo会以上次lineTo的节点为开始
      for (var i = 1; i < maxline / 25; i++) {
        context.beginPath();
        context.lineWidth = 0.2;
        if (i % 3 == 0) {
          context.lineWidth = 1.1;
        }
        if (i % 9 == 1) {
          setrules(25 * i);
        }
        if (i % 6 == 1) {
          context.font = "bold 10px consolas";
          context.textAlign = "left";
          context.textBaseline = "top";
          context.font = "bold 10px arial";
          context.fillStyle = "black";
          var flag = ((i - 1) / 6) % 2;
          if (flag == 0) {
            context.fillText(starttime, i * 25 - 20, max + 30);
          } else {
            context.fillText((i - 1) / 3 + "分", i * 25 - 20, max + 30);
          }
        }
        context.moveTo(25 * i + baseleft, 0);
        context.lineTo(25 * i + baseleft, ((max - min) * 15) / 10);
        context.stroke();
      }
      for (var i = 1; i < maxline / 25; i++) {
        context.beginPath();
        context.lineWidth = 0.2;
        if (i % 3 == 0) {
          context.lineWidth = 1.1;
        }
        if (i % 9 == 1) {
          setrules(25 * i);
        }
        context.moveTo(25 * i + baseleft, max + 60);
        context.lineTo(25 * i + baseleft, max + 60 + 150);
        context.stroke();
      }
    }
    function draw8(id) {
      var canvas = document.getElementById(id);
      if (canvas == null) return false;
      context = canvas.getContext("2d");
      var canvas2 = document.getElementById("canvas2");
      //testclear();
      //kisi set normal area
      if (fhr.length < 1500) {
        sethorizontal(1500);
        setvertical(1500);
      } else {
        canvas.width = fhr.length;
        canvas2.width = fhr.length;
        context.fillStyle = "rgb(224,255,255)"; //横向选择区域设置填充色
        context.fillRect(0, 50 * 1.5, fhr.length, 50 * 1.5);
        sethorizontal(fhr.length);
        setvertical(fhr.length);
      }
      context.beginPath();
      context.strokeStyle = "rgb(0,0,0)";
      //context.moveTo(baseleft, fhr1[0]);
      context.lineWidth = 0.8;
      lastx = 0;
      lasty = 0;
      for (var i = 1; i < fhr.length; i++) {
        lastx = i + baseleft;
        lasty = fhr[i];
        if (lasty == 0) {
          //alert(lastx);
          if (i + 1 < length) {
            context.moveTo(lastx, (max - fhr[i + 1]) * 1.5);
          }
        } else {
          if (i > 1 && lasty - fhr[i - 1] > 30) {
            //alert(lasty + '-' + fhr[i-1]);
            context.moveTo(lastx, (max - fhr[i]) * 1.5);
          } else if (i > 1 && fhr[i - 1] - lasty > 30) {
            context.moveTo(lastx, (max - fhr[i]) * 1.5);
          } else {
            context.lineTo(lastx, (max - lasty) * 1.5);
          }
        }
      }
      lastx = 0;
      lasty = 0;
      context.moveTo(lastx, 420);
      for (var i = 1; i < toco.length; i++) {
        lastx = i + baseleft;
        lasty = toco[i];
        context.lineTo(lastx, 420 - lasty * 1.5);
      }
      lastx = 0;
      lasty = 0;
      context.moveTo(lastx, 240);
      for (var i = 1; i < fmp.length; i++) {
        lastx = i + baseleft;
        lasty = fmp[i];
        context.lineTo(lastx, 240 - lasty * 1.5);
      }
      context.stroke();
      for (var i = 1; i < fm.length; i++) {
        if (fm[i] == 1) {
          showfm(i);
        }
      }
    }

    function movescoll() {
      Draw.move(currentx);
      currentx = currentx + 1;
      showcur(currentx, fhr[currentx], toco[currentx]);
    }

    function showfm(postion) {
      context.beginPath();
      context.strokeStyle = "rgb(153,254,153)";
      context.lineWidth = 4;
      context.moveTo(postion, max + 44);
      context.lineTo(postion, max + 52);
      context.stroke();
    }

    function printnext() {
      maxindex++;
      if (maxindex > maxline) {
        var canvas = document.getElementById("canvas");
        context = canvas.getContext("2d");
        maxline = maxindex + 100;
        canvas.width = maxline;
        setnewhorzontal();
        setvertical();
        context.beginPath();
        context.strokeStyle = "rgb(0,0,0)";
        context.moveTo(0, fhr1[0]);
        context.lineWidth = 0.8;
        for (var i = 1; i < fhr1.length; i++) {
          lastx = i + baseleft;
          lasty = fhr1[i];
          context.lineTo(lastx, (max - lasty) * 1.5);
        }
        context.stroke();
        document.getElementById("pecharts").scrollLeft = maxline; //通过scrollTop设置滚动到200位置
      }
      if (context != null) {
        context.beginPath();
        context.strokeStyle = "rgb(0,0,0)";
        context.lineWidth = 0.8;
        context.moveTo(lastx, (max - lasty) * 1.5);
        lastx = maxindex + baseleft;
        lasty = selectfrom(140, 155);
        fhr1[maxindex] = lasty;
        context.lineTo(lastx, (max - lasty) * 1.5);
        context.stroke();
        if (lasty == 153) {
          context.beginPath();
          context.strokeStyle = "rgb(153,254,153)";
          context.lineWidth = 4;
          context.moveTo(lastx, max + 44);
          context.lineTo(lastx, max + 52);
          context.stroke();
          showacc(lastx, (max - lasty) * 1.2);
        }
        lastcurrx = lastx;
        showcur(lastx, lasty, 20);
      }
      //context.closePath();
    }

    var Draw = {
      init: function() {
        this.cObj = document.getElementById("canvas2").getContext("2d");
        this.event();
        this.draw.prototype = this;
        this.p = new this.draw(20, 0, 6, 428, rulercolor); // 竖向选择线
        audio = document.getElementById("audio");
        audio.currentTime = 16;
        /*             window.setTimeout(function(){
                             this.p.draw(45,145,70,70,"red")
                         }.bind(this),2000)*/
      },
      draw: function(x, y, w, h, color) {
        this.cObj.clearRect(this.x - 1, this.y - 1, this.w + 2, this.h + 2);
        this.x = x;
        this.y = y;
        this.w = w;
        this.h = h;
        this.color = color;
        this.cObj.strokeStyle = this.color;
        this.cObj.strokeRect(this.x, this.y, this.w, this.h);
      },
      move: function(x) {
        this.p.draw(x, 0, 6, 428, rulercolor);
      },
      OnMouseMove: function(evt) {
        //timeout = true;
        if (this.p.isDown) {
          var X = evt.layerX - this.p.w / 2;
          var Y = evt.layerY - this.p.h / 2;
          this.p.draw(X, 0, 6, 428, rulercolor);
        }
        clearInterval();
      },
      OnMouseDown: function(evt) {
        btnaudiopause();
        var X = evt.layerX;
        var Y = evt.layerY;
        if (X < this.p.x + this.p.w && X > this.p.x) {
          if (Y < this.p.y + this.p.h && Y > this.p.y) {
            this.p.isDown = true;
          }
        } else {
          this.p.isDown = true;
        }
      },
      OnMouseUp: function(evt) {
        btnaudiopause();
        this.p.isDown = false;
        audio = document.getElementById("audio");
        seconds = (evt.layerX / 75) * 60;
        if (seconds > audio.duration) {
          //audio.pause();
          //btnaudiopause();
        } else {
          showcur(evt.layerX, fhr[evt.layerX], toco[evt.layerX]);
          currentx = evt.layerX;
          audio.currentTime = seconds;

          /*
	            audio.play();
	            timeout = false;
	            timerscoll(1000);
	            */
          //btnaudioplay();
          //setInterval("movescoll()", 1000);//1000为1秒钟 ,重入不准
        }
      },
      event: function() {
        var canvas = document.getElementById("canvas2");
        canvas.addEventListener(
          "mousedown",
          this.OnMouseDown.bind(this),
          false
        );
        canvas.addEventListener(
          "mousemove",
          this.OnMouseMove.bind(this),
          false
        );
        canvas.addEventListener("mouseup", this.OnMouseUp.bind(this), false);
      }
    };
    draw8("canvas");
    Draw.init();
  </script>
</html>
